Ця програма — бот для автоматизації спілкування з клієнтами типографії в Bitrix24. Вона інтегрує GPT для відповідей, відстежує угоди, обробляє дублікати та сповіщає менеджерів за потреби. Основна мета — зібрати дані для друку й передати їх у CRM, мінімізуючи ручну роботу.

Програма в цілому — це автоматизований чат-бот для типографій із детальним логуванням для відстеження роботи.

Загальний огляд роботи програми
Структура
Програма складається з кількох модулів:

BitrixMain.cs:
Основний цикл, який відстежує угоди в Bitrix24, аналізує чати й передає питання до GPT.
Обробляє дублікати, сповіщає менеджерів і надсилає відповіді в Bitrix24.
GptChat.cs:
Модуль для взаємодії з OpenAI, генерує відповіді на основі контексту з JSON-файлів.
Page.json (та інші):
Дані для навчання GPT, що визначають стиль і логіку відповідей.
settings.json:
Конфігурація для інтеграції з OpenAI, Bitrix24 і шаблонів повідомлень.
Логіка роботи
Старт:
BitrixMain.StartAsync запускає цикл, який кожні 3 хвилини перевіряє угоди в Bitrix24 (воронки 4 і 5).
Виявлення питань:
Знаходить чати з повідомленнями клієнтів, на які не відповів менеджер.
Запит до GPT:
Передає питання в GptChat.StartAsync із контекстом із Page.json (або іншого файлу залежно від проєкту).
GPT генерує відповідь, використовуючи інструкції з settings.json і приклади з JSON.
Обробка відповіді:
Якщо GPT повертає:
"Дані зібрано": Угода завершується, менеджер отримує сповіщення, чат архівується.
"Потрібна перевірка менеджера": Запит передається менеджеру, угода переміщується.
Інше: Відповідь надсилається в чат Bitrix24.
Додаткові функції:
Обробка дублікатів угод.
Повідомлення про вихідні (WEEKEND_TEXT) у неробочий час.
Призначення
Автоматизація спілкування з клієнтами типографії "Page" (а також "Веселка", "Kyivphoto").
Збір даних для друку (візитки, плакати, наліпки тощо) без вказівки цін.
Інтеграція з Bitrix24 для управління угодами та сповіщення менеджерів.

Приклади роботи:
Вхід: Клієнт: "Доброго дня. Цікавить друк візиток. Чи можна замовити 100 штук?"
Бот (згенеровано GPT на основі Page.json): "Для прорахунку ціни візиток нам потрібно знати: 1. Кількість... 2. Ламінація... 3. Друк з однієї чи двох сторін... 4. Чи є макет..."
Вхід: Клієнт: "100 штук, без ламінації, макету немає, двосторонні."
Бот: "Дані зібрано."
Дія: BitrixMain сповіщає менеджера в Bitrix24, угода переміщується на наступний етап.


Вхід: Клієнт пише в Bitrix24: "Хочу надрукувати 100 візиток".
Дії:
BitrixMain виявляє це питання й передає в GptChat.StartAsync.
GptChat завантажує Page.json, додає контекст і надсилає запит до GPT.
GPT повертає: "Добрий день! Уточніть, будь ласка, розмір візиток і тип паперу."
GptChat викликає returnResponse, і BitrixMain надсилає це в чат Bitrix24.
Вихідні: Якщо клієнт уточнює дані, а GPT відповідає "Дані зібрано.", BitrixMain сповіщає менеджера.

-----------------------------------------------------------------------------------------------

Program.cs — це "диригент" програми, який запускає та координує роботу всіх модулів. Програма в цілому — це чат-бот для типографій, який:

Використовує Bitrix24 як CRM і OpenAI для генерації відповідей.
Збирає дані для друку, спираючись на приклади з Page.json (та інших).
Автоматизує рутинні задачі, передаючи складні запити менеджерам.

Опис файлу Program.cs
Структура
Файл містить єдиний клас Program із статичним асинхронним методом Main, який є точкою входу в програму.

Основна логіка
Метод Main виконує такі дії:

Ініціалізація:
Створює CancellationTokenSource для управління зупинкою програми.
Виводить повідомлення про старт програми на екран через PrintToScreen.AddLine.
Встановлює кодування консолі на UTF-8 для коректного відображення кирилиці.
Налаштування логування та конфігурації:
Ініціалізує об’єкт логування (ILog log = new Log()).
Завантажує налаштування з settings.json через GetSettingsFile.GetSettingsDataAsync.
Створення папок:
Викликає CreateFolders.FoldersExist(), щоб переконатися, що необхідні папки (наприклад, для логів чи історії чатів) існують.
Підключення залежностей:
Передає об’єкт логування (log) у класи:
Ban_SetGet
QueueToGpt
Deal_Bitrix
GptChat
Передає налаштування (settings) у GptChat.SETTINGS.
Встановлює вебхук Bitrix24 (BITRIX_HOOK) для SendToBitrix і Deal_Bitrix.
Запуск основного процесу:
Створює екземпляр BitrixMain із логуванням і налаштуваннями.
Запускає асинхронний метод BitrixMain.StartAsync у окремому потоці через Task.Run, передаючи CancellationToken.
Очікування завершення:
Чекає введення користувача через Console.ReadLine() (закоментована логіка з обробкою клавіш Esc або Ctrl+Alt+N).
Після введення зупиняє чергу запитів до GPT (QueueToGpt.IsBreak = true) і скасовує всі потоки через cancellationToken.CancelAsync().
Обробка помилок:
Ловить винятки, виводить їх у консоль через PrintToScreen і зупиняє програму.
Використання settings.json
У Program.cs напряму використовується лише BITRIX_HOOK для ініціалізації вебхука Bitrix24. Решта налаштувань із settings.json передаються через об’єкт settings у BitrixMain і GptChat, де вони застосовуються:

OPENAI_KEY, OPENAI_PATH, MODEL_GPT: Для запитів до OpenAI у GptChat.
INSTRUCTS_FOR_GPT, SEND_MANAGER, DATA_COLLECTED, WEEKEND_TEXT: Інструкції та ключові фрази для GPT.
BITRIX_VORONKA, BITRIX_SOURCE_NAME, BITRIX_MY_PROJECTS_NAME, BITRIX_ADMIN_ID: Для роботи з угодами в BitrixMain.
Зв’язок із іншими файлами
BitrixMain.cs:
Запускається через BitrixMain.StartAsync і є основним циклом програми.
Використовує settings для доступу до воронок, джерел, проєктів тощо.
Передає питання клієнтів у GptChat через QueueToGpt.
GptChat.cs:
Отримує SETTINGS і Log із Program.cs.
Обробляє запити до OpenAI, використовуючи контекст із Page.json (або інших JSON-файлів).
Page.json (та інші):
Завантажується в GptChat як контекст для GPT залежно від проєкту (projectName).

-----------------------------------------------------------------------------------------------

 BitrixMain

Структура класу BitrixMain
Поля
_log (ILog):
Інтерфейс для логування подій (інформація, попередження, помилки).
Використовується для запису стану програми та помилок.
_SETTINGS (Settings_Prop):
Об’єкт із налаштуваннями, зчитаними з settings.json.
Містить конфігураційні дані, такі як ключі API, тексти повідомлень, ID адміністратора тощо.
_responseChatGpt_delegate (responseChatGpt):
Делегат для обробки відповідей від GPT. Посилається на метод SendMsgResponseAsync.
_listMainData (Dictionary<int, MainData>):
Словник, де ключ — ID угоди (dealID), а значення — об’єкт MainData із даними про угоду, контакт, чат тощо.
Зберігає активні угоди, які обробляються.
_dublikats (Dictionary<string, List<Deal>>):
Словник для зберігання дублікатів угод за ID контакту (clientID).
Використовується для групування та обробки повторних звернень від одного клієнта.

Основний метод: StartAsync Це основний цикл програми
Ініціалізація масивів із settings.json:
Розбиває рядки BITRIX_VORONKA, BITRIX_SOURCE_NAME, BITRIX_MY_PROJECTS_NAME на масиви (voronki_arr, source_name_arr, projects_name_arr) для подальшої роботи з воронками, джерелами та проєктами.
Цикл обробки угод:
Виконується безперервно, поки не отримано сигнал скасування (cancellationToken).
Кожні 3 хвилини (Task.Delay(180000)) перевіряє угоди в Bitrix24.
Отримання угод:
Для кожної воронки з voronki_arr викликається Deal_Bitrix.GetDealAsync, щоб отримати список угод.
Якщо угод немає, очищається _listMainData і цикл чекає 3 хвилини.
Очищення неактивних угод:
Перевіряє, чи є в _listMainData угоди, яких уже немає в першій колонці Bitrix24, і видаляє їх.
Обробка кожної угоди:
Фільтрує угоди за джерелом (SOURCE_ID) із source_name_arr.
Визначає ім’я клієнта з заголовка угоди (TITLE).
Перевіряє дублікати (IsDealDublicat) або наявність угоди в _listMainData.
Отримує історію чату через методи Deal_Bitrix:
GetOpenLineChatIDAsync — список чатів контакту.
GetOpenLineDialogInfoAsync — інформація про відкритий діалог.
GetOpenLineChatHistoryAsync — історія повідомлень.
Аналіз історії чату:
Перевіряє, чи є повідомлення клієнта без відповіді менеджера (IS_ManagerHasReplied).
Якщо є, витягує ці повідомлення (GetClientMsgWithoutManagerRiple) і надсилає їх до GPT (QueryToGptChatAsync).
Оновлення даних:
Додає нову угоду до _listMainData або оновлює її, зберігаючи ID останнього повідомлення клієнта.
Допоміжні методи
GetClientMsgWithoutManagerRiple
Повертає текст повідомлень клієнта, на які ще не відповів менеджер.
Фільтрує повідомлення за SENDERID, виключаючи менеджера та адміністратора (BITRIX_ADMIN_ID).
Оновлює lastMsgClientID для відстеження останнього повідомлення.
SetDublicatToListAsync
Додає угоду до словника дублікатів (_dublikats) за CONTACT_ID.
Логує інформацію про дублікат.
IsDealDublicat
Перевіряє, чи є угода дублікатом, порівнюючи CONTACT_ID, ім’я клієнта та джерело звернення.
Використовує час створення угоди для виключення старих дублікатів.
IS_ManagerHasReplied
Повертає true, якщо останнє повідомлення в чаті від менеджера, інакше false.
Аналізує історію чату за датою повідомлень.
QueryToGptChatAsync
Надсилає запит клієнта до GPT через чергу (QueueToGpt.SetToQueueAsync).
Використовує історію чату (GetChatHistory.GetListHistoryAsync) і назву проєкту (GetProjectName).
SendMsgResponseAsync
Обробляє відповідь від GPT і надсилає її в Bitrix24.
Якщо відповідь містить:
"Потрібна перевірка менеджера" (SEND_MANAGER): сповіщає менеджера, архівує чат, видаляє угоду.
"Дані зібрано" (DATA_COLLECTED): сповіщає менеджера, архівує чат, видаляє угоду.
Інакше: надсилає відповідь у чат через Deal_Bitrix.SendMsgToOpenLineAsync.
SendTo_Menager_BitrixAsync
Переміщує угоду та її дублікати на наступний етап у Bitrix24.
Надсилає сповіщення менеджеру через SendToBitrix.SendToMenegerAsync.
GetProjectName
Визначає назву проєкту (наприклад, "Page", "Веселка") за заголовком угоди.

Використання settings.json
Код активно використовує такі налаштування з settings.json:

BITRIX_VORONKA ("4,5") — воронки продажів для перевірки угод.
BITRIX_SOURCE_NAME — джерела звернень для фільтрації угод.
BITRIX_MY_PROJECTS_NAME — назви проєктів для визначення бренду.
BITRIX_ADMIN_ID ("2321") — ID адміністратора для виключення його повідомлень і відправки від його імені.
SEND_MANAGER ("Потрібна перевірка менеджера") — фраза для передачі запиту менеджеру.
DATA_COLLECTED ("Дані зібрано.") — фраза для завершення збору даних.
FIRST_OUT_MSG — може використовуватися в інших частинах коду для початкового повідомлення (тут не явно).

----------------------------------------------------------------------------------------

QueueToGpt.cs — це проміжний модуль, який забезпечує асинхронну обробку запитів до GPT із затримкою 1 хвилина, уникаючи перевантаження API OpenAI. Він:

Додає потокобезпечність через ConcurrentQueue і Interlocked.
Об’єднує питання від одного клієнта для економії запитів.
Зв’язує BitrixMain і GptChat для плавної роботи бота.

Опис файлу QueueToGpt.cs
Структура
QueueToGpt — це статичний клас, який реалізує асинхронну чергу для обробки запитів до GPT (через GptChat). Він використовує потокобезпечну структуру ConcurrentQueue для управління запитами в багатопотоковому середовищі.

Поля
IsBreak (bool):
Прапорець для зупинки черги. Встановлюється в true у Program.cs при завершенні програми.
Log (ILog):
Статичне поле для логування подій і помилок. Ініціалізується в Program.cs.
_responseChatGpt_delegate (responseChatGpt):
Делегат для повернення відповідей від GPT. Посилається на SendMsgResponseAsync із BitrixMain.
_msgQueue (ConcurrentQueue<(int, string, string, string)>):
Потокобезпечна черга, яка зберігає кортежі:
int: ID угоди (dealID).
string: Питання клієнта (userQuestion).
string: Історія чату (clientChatHistory).
string: Назва проєкту (projectName).
_check (long) та _IsWait (bool):
Використовуються для блокування доступу до черги в багатопотоковому середовищі через Interlocked.
_IsWait вказує, чи черга тимчасово заблокована для модифікації.

Призначення: Додає запит клієнта до черги для обробки GPT.
Параметри:
userID: ID угоди.
userQuestion: Питання клієнта.
clientChatHistory: Історія чату.
projectName: Назва проєкту (наприклад, "Page").
responseChatGpt_delegate: Делегат для повернення відповіді.
Логіка:
Зберігає делегат у _responseChatGpt_delegate.
Перевіряє, чи є в черзі запит із таким же userID:
Якщо є, об’єднує нове питання з існуючим (додає через пробіл), оновлюючи чергу.
Якщо немає, додає новий кортеж до черги.
Використовує _IsWait для синхронізації доступу до черги.
Логує помилки, якщо вони виникають, і розблоковує чергу.

Призначення: Безперервно обробляє чергу запитів до GPT.
Логіка:
Працює в циклі, поки IsBreak не стане true.
Якщо черга не порожня і не заблокована (!_IsWait):
Витягує запит із черги через TryDequeue.
Перевіряє валідність (userID > 0 і питання не null).
Викликає GptChat.StartAsync із параметрами запиту та делегатом.
Логує помилки, якщо не вдається витягти чи обробити запит.
Чекає 1 хвилину (Task.Delay(60000)) перед наступною ітерацією.
При IsBreak = true очищає чергу й завершує цикл.
Зв’язок із іншими файлами
Program.cs:
Ініціалізує Log і запускає чергу через конструктор.
Зупиняє чергу, встановлюючи IsBreak = true при завершенні програми.
BitrixMain.cs:
Викликає SetToQueueAsync у методі QueryToGptChatAsync, передаючи питання клієнта й делегат SendMsgResponseAsync.
Отримує відповіді від GPT через делегат і обробляє їх (надсилає в Bitrix24, сповіщає менеджера тощо).
GptChat.cs:
Отримує запити з черги через StartWhileAsync, викликаючи GptChat.StartAsync.
Генерує відповіді й повертає їх через _responseChatGpt_delegate.
settings.json:
Не використовується напряму, але впливає через GptChat.SETTINGS (наприклад, OPENAI_KEY, INSTRUCTS_FOR_GPT).
Page.json (та інші):
Використовується в GptChat як контекст для генерації відповідей на запити з черги.

----------------------------------------------------------------------------------------

GptChat.cs — це модуль для зв’язку з OpenAI, який:

Генерує відповіді на основі інструкцій із settings.json і підготовлених даних.
Враховує робочий час (частково закоментоване).
Повертає відповіді в BitrixMain для інтеграції з Bitrix24.

Загальний огляд файлу GptChat.cs
Цей файл реалізує клас GptChat, який відповідає за взаємодію з API OpenAI для генерації відповідей на запити клієнтів. Він є частиною системи, яка інтегрує Bitrix24 із чат-ботом на базі OpenAI (GPT). Основна функція — обробляти питання клієнтів, використовуючи контекст із підготовлених даних, історію чату та інструкції з settings.json, і повертати відповіді через делегат responseChatGpt.

Структура класу GptChat
Поля
Log (ILog):
Статичне поле для логування подій і помилок.
Використовується для запису інформації про роботу класу.
SETTINGS (Settings_Prop):
Статичне поле з налаштуваннями, зчитаними з settings.json.
Містить ключі API, модель GPT, інструкції тощо.
_IsSendOnWeekends (закоментоване):
Список ID користувачів, яким уже надіслали повідомлення про вихідні.
Зараз закоментоване, але могло використовуватися для уникнення повторних повідомлень у неробочий час.

Основний метод: StartAsync
Параметри:
userID — ідентифікатор користувача (ймовірно, ID угоди з Bitrix24).
userQuestion — текст запитання клієнта.
clientChatHistory — історія попереднього спілкування з клієнтом.
projectName — назва проєкту (наприклад, "Page", "Веселка").
returnResponse — делегат для повернення відповіді (посилається на SendMsgResponseAsync із BitrixMain).
Логіка роботи:
Завантаження даних:
Завантажує JSON-файл із даними для проєкту (наприклад, Page.json) із папки, визначеної в ConstantFolders.DATASET_PATH.
Ці дані містять приклади питань (prompt) і відповідей (response).
Формування контексту:
Викликає FormatContext, щоб створити текстовий контекст із пар "Клієнт: ... Менеджер: ...".
Перевірка робочого часу (закоментована):
Логіка для обробки вихідних і неробочих годин закоментована, але могла:
Надсилати WEEKEND_TEXT у п’ятницю після 18:00, суботу чи неділю.
Повідомляти про робочий час (9:00–18:00) у разі звернень уночі.
Очищати список _IsSendOnWeekends у робочі години.
Запит до GPT:
Викликає QueryGPT4Async із питанням клієнта, контекстом і історією чату.
Отримує відповідь від моделі OpenAI.
Повернення відповіді:
Якщо відповідь отримана, передає її через делегат returnResponse.
Обробка помилок:
Логує будь-які винятки, що виникають під час роботи.
Допоміжні методи
LoadJsonDataAsync
Завантажує JSON-файл із диска за шляхом filePath (наприклад, DATASET_PATH/Page.json).
Десеріалізує його в динамічний об’єкт за допомогою Newtonsoft.Json.
FormatContext
Перетворює дані з JSON у текстовий формат: "Клієнт: [питання] Менеджер: [відповідь]".
Використовує StringBuilder для ефективного створення рядка.
QueryGPT4Async
Надсилає HTTP-запит до API OpenAI для генерації відповіді.
Логіка:
Додає історію чату до контексту, якщо вона є.
Перевіряє, чи це вихідні, і додає WEEKEND_TEXT до інструкцій, якщо так.
Формує JSON-запит із:
Моделлю (MODEL_GPT, наприклад, "gpt-4o-mini").
Масивом повідомлень:
Системне повідомлення з INSTRUCTS_FOR_GPT + SEND_MANAGER + WEEKEND_TEXT.
Системне повідомлення з контекстом.
Повідомлення користувача (userInput).
Надсилає POST-запит до OPENAI_PATH із ключем OPENAI_KEY.
Повертає текст відповіді з choices[0].message.content.
Обробка помилок: Повертає null, якщо запит не вдався, із логуванням винятку.
Використання settings.json
Код використовує такі налаштування з settings.json:

OPENAI_KEY:
Використовується в заголовку Authorization для автентифікації в API OpenAI.
OPENAI_PATH:
URL для надсилання запитів до OpenAI (https://api.openai.com/v1/chat/completions).
MODEL_GPT:
Назва моделі GPT ("gpt-4o-mini"), яка вказується в запиті.
INSTRUCTS_FOR_GPT:
Інструкція для GPT, наприклад: "Ви є ботом у сфері поліграфії, збирайте дані для прорахунку друку...".
SEND_MANAGER:
Фраза "Потрібна перевірка менеджера", додана до інструкцій для складних запитів.
WEEKEND_TEXT:
Текст "Одразу треба попередити клієнта, що ми не працюємо до понеділка", який додається до інструкцій у вихідні.
DATA_COLLECTED (опосередковано):
Не використовується напряму тут, але GPT може включити цю фразу у відповідь за інструкціями.

Зв’язок із BitrixMain.cs
Виклик із BitrixMain:
У BitrixMain.QueryToGptChatAsync викликається QueueToGpt.SetToQueueAsync, який, ймовірно, передає запит до GptChat.StartAsync.
Делегат responseChatGpt посилається на SendMsgResponseAsync із BitrixMain.
Потік даних:
BitrixMain виявляє питання клієнта й передає його в GptChat.StartAsync разом із userID, userQuestion, clientChatHistory і projectName.
GptChat обробляє запит через OpenAI і повертає відповідь у BitrixMain.SendMsgResponseAsync.
BitrixMain надсилає відповідь у Bitrix24 або сповіщає менеджера.
Загальна логіка роботи
Вхідні дані:
Отримує питання клієнта, історію чату та назву проєкту від BitrixMain.
Підготовка:
Завантажує дані проєкту з JSON-файлу (наприклад, Page.json) для контексту.
Запит до GPT:
Формує запит із інструкціями, контекстом, історією та питанням.
Надсилає його до OpenAI й отримує відповідь.
Повернення результату:
Передає відповідь назад у BitrixMain через делегат для подальшої обробки.

----------------------------------------------------------------------------------------

Опис файлу Log.cs
Структура
Log — це клас, який реалізує інтерфейс ILog для асинхронного логування подій програми та повідомлень чату. Він використовує черги (AsyncQueue) для потокобезпечної обробки записів і підтримує два типи логів: загальні (помилки, сповіщення) та повідомлення чату (питання/відповіді).

Log.cs — це модуль логування, який:
Забезпечує асинхронне, потокобезпечне записування подій і повідомлень.
Використовує черги для обробки в реальному часі.
Зберігає логи в файлах і виводить на екран.

Делегати
LogDelegate:
Сигнатура: Task LogDelegate(object obj, string str, LogLevels logLevels).
Призначення: Логування подій програми (помилок, інформації тощо).
Параметри:
obj: Об’єкт, який викликав логування (наприклад, клас).
str: Текст повідомлення.
logLevels: Рівень логування (Info, Error, Success тощо).
LogMsgDelegate:
Сигнатура: Task LogMsgDelegate(string userID, string msg).
Призначення: Логування питань і відповідей у чаті.
Параметри:
userID: Ідентифікатор користувача (ймовірно, ID угоди).
msg: Текст повідомлення.
Поля
LogDelegate та LogMsgDelegate:
Властивості, які зберігають делегати для логування. Ініціалізуються в конструкторі.
_asyncQueue (AsyncQueue<(string, LogLevels)>):
Черга для загальних логів (текст і рівень логування).
_asyncMsgQueue (AsyncQueue<(string, string)>):
Черга для повідомлень чату (ID користувача і текст).
_lockObj (object):
Об’єкт для синхронізації доступу до файлів у багатопотоковому середовищі.

Конструктор
public Log()

Ініціалізує делегати:
LogDelegate → HandleOutAsync.
LogMsgDelegate → AddToQueueAsync.
Створює порожні черги _asyncQueue і _asyncMsgQueue.
Логує початкове повідомлення: "Логірованиє працює." з рівнем Info.
Основні методи
HandleOutAsync
Призначення: Додає загальні логи до черги та запускає їх обробку.
Логіка:
Додає запис (текст із датою + повідомлення + об’єкт, рівень) у _asyncQueue.
Запускає Start у фоновому потоці для обробки черги.
Start
Призначення: Обробляє чергу загальних логів.
Логіка:
Витягує записи з _asyncQueue.
Виводить їх на екран через PrintToScreen.AddLine.
Записує у файл через LogToFile.
Працює, поки черга не спорожніє.
LogToFile
Призначення: Записує текст у файл логів.
Логіка:
Використовує RealPath() для визначення шляху (за замовчуванням — лог за поточною датою).
Додає текст у файл через StreamWriter.
Логує помилки на екран, якщо запис не вдався.
AddToQueueAsync
Призначення: Додає повідомлення чату до черги та запускає їх обробку.
Логіка:
Додає запис (userID, msg) у _asyncMsgQueue.
Запускає StartWhileMsg у фоновому потоці.
StartWhileMsg
Призначення: Обробляє чергу повідомлень чату.
Логіка:
Витягує записи з _asyncMsgQueue.
Виводить на екран через PrintToScreen.AddLine із форматом userID: msg.
Записує у файл через MsgToFile.
Працює, поки черга не спорожніє (хоча умовою є !_asyncQueue.IsEmpty, що, ймовірно, помилка — має бути _asyncMsgQueue).
MsgToFile
Призначення: Записує повідомлення чату у файл.
Логіка:
Використовує RealPath(userID) для створення файлу за ID користувача.
Додає текст у файл через StreamWriter.
Логує помилки на екран.
RealPath
Призначення: Визначає шлях до файлу логів.
Логіка:
Синхронізується через lock (_lockObj) для потокобезпеки.
Якщо path не вказано: повертає шлях до загального логу (LOGS_FOLDER/дата.txt).
Якщо path вказано: повертає шлях до файлу чату (MSG_FOLDER/userID.txt).
Створює файл, якщо його немає.
Зв’язок із іншими файлами
Program.cs:
Ініціалізує Log через ILog log = new Log() і передає його в усі модулі (BitrixMain, GptChat, QueueToGpt тощо).
Викликає логування помилок при винятках.
BitrixMain.cs:
Використовує LogDelegate для запису подій (наприклад, помилок у StartAsync) і LogMsgDelegate для питань/відповідей у SendMsgResponseAsync.
GptChat.cs:
Логує помилки через Log.LogDelegate (наприклад, у QueryGPT4Async).
QueueToGpt.cs:
Логує помилки додавання в чергу чи обробки через Log.LogDelegate.
Page.json:
Не має прямого зв’язку, але логи повідомлень чату (питання/відповіді) базуються на взаємодії з клієнтами, описаними в JSON.
settings.json:
Не використовується напряму, але логи можуть включати ключові фрази (SEND_MANAGER, DATA_COLLECTED).
Використання settings.json
Log.cs не звертається до settings.json напряму, але опосередковано залежить від нього через інші модулі:

Наприклад, BitrixMain.SendMsgResponseAsync логує відповіді, які містять SEND_MANAGER чи DATA_COLLECTED.

----------------------------------------------------------------------------------------

Опис файлу CreateFolders.cs
Структура
CreateFolders — це внутрішній (internal) статичний клас, який відповідає за створення необхідних папок для роботи програми. Він використовує константи, визначені в ConstantFolders, для вказівки шляхів до папок.

Метод
public static void FoldersExist()

Призначення: Перевіряє існування ключових папок програми та створює їх, якщо вони відсутні.
Логіка:
Перевіряє, чи існують папки:
BAN_FOLDER: Для зберігання інформації про заблокованих користувачів (імовірно).
LOGS_FOLDER: Для логів подій програми.
MSG_FOLDER: Для логів повідомлень чату (питань і відповідей).
ARHIV_FOLDER: Для архівних файлів (наприклад, завершених чатів).
Якщо будь-яка з папок відсутня, створює всі чотири папки за допомогою Directory.CreateDirectory.
Константи
Клас залежить від ConstantFolders (імовірно, визначеного в BitrixGpt.Constants), де зберігаються шляхи до папок, наприклад:

ConstantFolders.BAN_FOLDER — "./Ban/"
ConstantFolders.LOGS_FOLDER — "./Logs/"
ConstantFolders.MSG_FOLDER — "./Messages/"
ConstantFolders.ARHIV_FOLDER — "./Archive/"

----------------------------------------------------------------------------------------

settings.json

Інтеграція з OpenAI:
Використовує модель gpt-4o-mini для обробки запитів клієнтів через API OpenAI (OPENAI_PATH і OPENAI_KEY).
Бот спілкується з клієнтами, збирає дані для прорахунку друку (згідно з INSTRUCTS_FOR_GPT), виправляє помилки в тексті та передає складні запити менеджерам.
Інтеграція з Bitrix24:
Через вебхук (BITRIX_HOOK) програма взаємодіє з Bitrix24, створюючи угоди, повідомлення чи задачі.
Підтримує кілька джерел (BITRIX_SOURCE_NAME) і проєктів (BITRIX_MY_PROJECTS_NAME), таких як "Page" і "Веселка".
Працює з певними воронками продажів (BITRIX_VORONKA) і від імені адміністратора (BITRIX_ADMIN_ID).
Обробка клієнтських звернень:
Надсилає початкове повідомлення (FIRST_OUT_MSG) із контактами та рекламою.
Повідомляє про завершення збору даних (DATA_COLLECTED) або закриття угоди (DEAL_CLOSED).
Попереджає про вихідні (WEEKEND_TEXT), якщо звернення надійшло в неробочий час.

---------------------------------------------------------------------------------------

Файл Page.json (Kyivphoto.json, Veselka.json) — це база знань для GPT, яка допомагає боту відповідати клієнтам типографії "Page". Програма в цілому — це автоматизований чат-бот, який:

Опис файлу Page.json (Kyivphoto.json, Veselka.json, data_chat.json)
Структура
Файл є масивом об’єктів, де кожен об’єкт має два поля:

prompt: Питання або звернення клієнта (може бути українською чи російською).
response: Відповідь, яку має надати менеджер або бот.
Призначення
Цей файл завантажується методом LoadJsonDataAsync у GptChat.cs і слугує контекстом для GPT-моделі.
GPT використовує ці приклади, щоб:
Збирати дані для прорахунку друку (наприклад, розмір, тираж, тип паперу).
Надавати інформацію про послуги, терміни, контакти.
Передавати складні запити менеджеру ("Потрібна перевірка менеджера").
Повідомляти про завершення збору даних ("Дані зібрано").
Приклади вмісту
Запит про візитки:
Prompt: "Доброго дня. Цікавить друк візиток. Чи можна замовити 100 штук? Які терміни виготовлення?"
Response: Запит даних (кількість, ламінація, сторони, макет) + інформація про терміни (1-2 дні дизайн, до 5 днів друк).
Повний набір даних:
Prompt: "100 штук, без ламінації, макету не має, двосторонні"
Response: "Якщо всі ці параметри отримано, повідомте клієнту 'Дані зібрано'."
Складний запит:
Prompt: "Доброго дня. Порахуйте, будь ласка, 2 баннера на люверсах..."
Response: "Потрібна перевірка менеджера".
Інформація:
Prompt: "Який графік роботи у вас?"
Response: Посилання на сайт із контактами.
Особливості
Підтримує двомовність (українська та російська).
Більшість відповідей спрямовані на збір даних, уникаючи вказівки цін (згідно з інструкціями INSTRUCTS_FOR_GPT).
Є спеціальні відповіді для вихідних, доставки, скарг тощо.
Зв’язок із кодом
GptChat.cs
Завантаження: Метод LoadJsonDataAsync зчитує Page.json (або Kyivphoto.json, Veselka.json залежно від projectName).
Контекст: FormatContext перетворює дані в текст (наприклад, "Клієнт: [питання] Менеджер: [відповідь]"), який додається до запиту в QueryGPT4Async.
Запит до GPT: GPT отримує контекст із Page.json, інструкції з settings.json і питання клієнта, щоб згенерувати відповідь.
BitrixMain.cs
Передача питання: QueryToGptChatAsync викликає GptChat.StartAsync, передаючи userQuestion, clientChatHistory і projectName (наприклад, "Page").
Обробка відповіді: SendMsgResponseAsync аналізує відповідь GPT:
Якщо є "Дані зібрано", сповіщає менеджера й завершує угоду.
Якщо є "Потрібна перевірка менеджера", передає запит менеджеру.
Інакше надсилає відповідь у чат Bitrix24.
settings.json
Використовуються:
OPENAI_KEY, OPENAI_PATH, MODEL_GPT — для запиту до OpenAI.
INSTRUCTS_FOR_GPT — інструкція для GPT (збирати дані, не вказувати ціни).
SEND_MANAGER, DATA_COLLECTED, WEEKEND_TEXT — ключові фрази для обробки відповідей.
